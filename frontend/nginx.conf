server {
    listen 8080;
    server_name inventory.example.com localhost;

    # Optimization: Useful for Kubernetes DNS resolution
    # resolver 127.0.0.11 valid=30s; 

    # 1. Serve static frontend files
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 2. Route to Auth Service
    location /api/auth/ {
        # 'auth' is the service name in Docker Compose/K8s
        proxy_pass http://auth:4000/auth/;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. Route to Inventory Service
    location /api/products/ {
        # 'backend' is the service name in Docker Compose/K8s
        proxy_pass http://backend:5000/api/products/;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Explicitly pass JWT headers
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Authorization;
    }

    # 4. Security Headers
    server_tokens off;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
}

